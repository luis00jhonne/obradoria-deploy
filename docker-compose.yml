services:
  backend:
    image: ghcr.io/${GHCR_USER}/obradoria-backend:latest
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:${DB_PORT:-5432}/${DB_NAME:-obradoria}
      SPRING_DATASOURCE_USERNAME: ${DB_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
    expose: ["8891"]

  agent:
    image: ghcr.io/${GHCR_USER}/obradoria-agent:latest
    restart: unless-stopped
    depends_on:
      backend: { condition: service_started }
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-obradoria}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD}
      SPRING_API_URL: http://backend:8891/api
      JWT_SECRET: ${JWT_SECRET}
      DEFAULT_LLM_PROVIDER: ${DEFAULT_LLM_PROVIDER:-anthropic}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      CORS_ORIGINS: ${CORS_ALLOWED_ORIGINS}
    expose: ["8000"]

  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    depends_on: [backend, agent]
    ports: ["80:80", "443:443"]
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config

volumes:
  caddy_data:
  caddy_config:
